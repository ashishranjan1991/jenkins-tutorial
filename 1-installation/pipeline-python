pipeline {
    agent any

    stages {
        stage('cloning the repo') {
            steps {
              git branch: 'main', changelog: false, poll: false, url: 'https://github.com/ashishranjan1991/jenkins-tutorial.git'
            }
        }
    stage('building app') {
            steps {
                dir('4-python-jenkins-docker-app') {
                    sh 'python3 -m py_compile app.py'
                }
        }
        
    }
    stage('Unit test') {
            steps {
                dir('4-python-jenkins-docker-app') {
                    sh 'python3 -m unittest discover tests'
                }
             }
        }
    stage('Docker login & tagging') {
            steps {
                dir('4-python-jenkins-docker-app'){
                withCredentials([usernamePassword(credentialsId: 'ashish0ran', passwordVariable: 'dockerpassword', usernameVariable: 'dockerusername')]) {
                    sh '''echo $dockerpassword | docker login -u $dockerusername --password-stdin
                          docker build -t ashish0ran/python:latestv1 .
                          docker push ashish0ran/python:latestv1 '''
                }
                }
             }
        }
}
}
